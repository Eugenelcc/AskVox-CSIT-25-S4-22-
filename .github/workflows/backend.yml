name: Backend CI

on:
  push:
    branches: [main, Development-Branch-]
  pull_request:
    branches: [main, Development-Branch-]
 
jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Ruff (must pass)
        run: ruff check backend

     # - name: Black (must pass)
      #  run: black --check backend

  test:
    name: Tests + Migrations + Postgres (Docker Compose)
    runs-on: ubuntu-latest
    needs: lint

    env:
      # When using docker compose the DB is reachable via the mapped host port.
      # Compose mapping in backend/docker-compose.yml is currently "5433:5432".
      DATABASE_URL: postgresql+asyncpg://askvox_user:askvox_pw@127.0.0.1:5433/askvox_db
      DATABASE_URL_SYNC: postgresql+psycopg://askvox_user:askvox_pw@127.0.0.1:5433/askvox_db
      PYTHONPATH: ${{ github.workspace }}/backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Set up Docker Compose
        run: |
          cd backend
          docker compose -f docker-compose.yml up -d --build

      - name: Wait for Postgres (compose)
        run: |
          cd backend
          for i in $(seq 1 30); do
            if docker compose exec -T db pg_isready -U askvox_user -d askvox_db >/dev/null 2>&1; then
              echo "Postgres is available"
              exit 0
            fi
            echo "Waiting for Postgres... ($i/30)"
            sleep 2
          done
          echo "Timed out waiting for Postgres"
          docker compose logs db || true
          exit 1

      - name: Run Alembic migrations (inside api container)
        run: |
          cd backend
          docker compose exec -T api bash -lc "PYTHONPATH=/app alembic -c alembic.ini upgrade head"

      - name: Run tests (inside api container)
        run: |
          cd backend
          docker compose exec -T api bash -lc "PYTHONPATH=/app pytest ./tests/system/test_system_endpoints.py -q -rs -vv"

      - name: Tear down compose
        if: always()
        run: |
          cd backend
          docker compose down --volumes --remove-orphans

      - name: Upload pytest cache (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-cache
          path: backend/.pytest_cache
          if-no-files-found: ignore
